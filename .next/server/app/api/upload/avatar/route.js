(()=>{var a={};a.id=503,a.ids=[503],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5185:(a,b,c)=>{"use strict";c.d(b,{A8:()=>r,Mp:()=>p,rc:()=>q});var d=c(33873),e=c.n(d),f=c(79748),g=c.n(f),h=c(9288),i=c.n(h);let j=["image/jpeg","image/jpg"],k=["audio/wav"];function l(a){return a.replace(/[^a-zA-Z0-9-_]/g,"_")}function m(a,b){if("image"===b){if(a.size>0xa00000)return{valid:!1,error:`K\xedch thước ảnh vượt qu\xe1 giới hạn (tối đa 10MB)`};if(!j.includes(a.type))return{valid:!1,error:`Loại file ảnh kh\xf4ng được hỗ trợ. Chỉ chấp nhận: ${j.join(", ")}`}}else if("audio"===b){if(a.size>0x6400000)return{valid:!1,error:`K\xedch thước file \xe2m thanh vượt qu\xe1 giới hạn (tối đa 100MB)`};if(!k.includes(a.type)&&""!==a.type)return{valid:!1,error:`Loại file \xe2m thanh kh\xf4ng được hỗ trợ. Chỉ chấp nhận: ${k.join(", ")}`}}return{valid:!0}}async function n(a){try{await g().access(a)}catch(b){await g().mkdir(a,{recursive:!0})}}async function o(a){try{let b=i()(a),c=await b.metadata(),d=Math.min(c.width||0,c.height||0);if(c.width===c.height||0===d)return a;let e=c.width&&c.width>d?Math.floor((c.width-d)/2):0,f=c.height&&c.height>d?Math.floor((c.height-d)/2):0;return await b.extract({left:e,top:f,width:d,height:d}).toBuffer()}catch(b){return console.error("Error cropping image:",b),a}}async function p(a,b,c,d,f){try{if(!c||!d||!f)return{success:!1,error:"Missing required fields: artistName, songTitle, or isrc"};let b=m(a,"audio");if(!b.valid)return{success:!1,error:b.error};let h=l(c),i=l(d),j=e().join(process.cwd(),"public","uploads",h,i);try{await n(j)}catch(a){return console.error("Error creating directory:",a),{success:!1,error:`Kh\xf4ng thể tạo thư mục lưu trữ: ${a.message}`}}let k=".wav";("audio/mpeg"===a.type||"audio/mp3"===a.type)&&(k=".mp3");let o=`${f}${k}`,p=e().join(j,o);try{let b=await a.arrayBuffer();await g().writeFile(p,Buffer.from(b))}catch(a){return console.error("Error writing file:",a),{success:!1,error:`Kh\xf4ng thể lưu file: ${a.message}`}}let q=`/uploads/${h}/${i}/${o}`;return{success:!0,url:q,key:q}}catch(a){return console.error("Upload audio error:",a),{success:!1,error:`Lỗi kh\xf4ng x\xe1c định: ${a.message}`}}}async function q(a,b,c,d,f){try{if(!c||!d||!f)return{success:!1,error:"Missing required fields: artistName, songTitle, or isrc"};let b=m(a,"image");if(!b.valid)return{success:!1,error:b.error};let h=l(c),i=l(d),j=e().join(process.cwd(),"public","uploads",h,i);try{await n(j)}catch(a){return console.error("Error creating directory:",a),{success:!1,error:`Kh\xf4ng thể tạo thư mục lưu trữ: ${a.message}`}}let k=".jpg";"image/png"===a.type&&(k=".png");let p=`${f}${k}`,q=e().join(j,p);try{let b=await a.arrayBuffer();await g().writeFile(q,Buffer.from(b))}catch(a){return console.error("Error writing file:",a),{success:!1,error:`Kh\xf4ng thể lưu file: ${a.message}`}}try{let a=await g().readFile(q),b=await o(a);await g().writeFile(q,b)}catch(a){return console.error("Error processing image:",a),{success:!1,error:`Kh\xf4ng thể xử l\xfd ảnh: ${a.message}`}}let r=`/uploads/${h}/${i}/${p}`;return{success:!0,url:r,key:r}}catch(a){return console.error("Upload image error:",a),{success:!1,error:`Lỗi kh\xf4ng x\xe1c định: ${a.message}`}}}async function r(a,b){try{if(!b)return{success:!1,error:"Missing artistName"};if(!j.includes(a.type))return{success:!1,error:`Loại file ảnh kh\xf4ng được hỗ trợ. Chỉ chấp nhận: ${j.join(", ")}`};let c=l(b),d=e().join(process.cwd(),"public","uploads",c,"Avatar");try{await n(d)}catch(a){return console.error("Error creating avatar directory:",a),{success:!1,error:`Kh\xf4ng thể tạo thư mục lưu trữ avatar: ${a.message}`}}let f=1,h=`avatar${f}.jpg`,i=e().join(d,h);for(;;)try{await g().access(i),f++,h=`avatar${f}.jpg`,i=e().join(d,h)}catch{break}try{let b=await a.arrayBuffer(),c=Buffer.from(b);console.log(`🔄 Cropping avatar to 1:1 ratio (original size: ${a.size} bytes)`);let d=await o(c);console.log(`✂️ Avatar cropped successfully (size after crop: ${d.length} bytes)`),await g().writeFile(i,d)}catch(a){return console.error("Error processing or writing avatar file:",a),{success:!1,error:`Kh\xf4ng thể xử l\xfd hoặc lưu file avatar: ${a.message}`}}let k=`/uploads/${c}/Avatar/${h}`;return{success:!0,url:k,key:k}}catch(a){return console.error("Upload avatar error:",a),{success:!1,error:`Lỗi kh\xf4ng x\xe1c định: ${a.message}`}}}},9288:a=>{"use strict";a.exports=require("sharp")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{"use strict";a.exports=require("path")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},79748:a=>{"use strict";a.exports=require("fs/promises")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},87317:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>O,patchFetch:()=>N,routeModule:()=>J,serverHooks:()=>M,workAsyncStorage:()=>K,workUnitAsyncStorage:()=>L});var d={};c.r(d),c.d(d,{POST:()=>I});var e=c(96559),f=c(48088),g=c(37719),h=c(26191),i=c(81289),j=c(261),k=c(92603),l=c(39893),m=c(14823),n=c(47220),o=c(66946),p=c(47912),q=c(99786),r=c(46143),s=c(86439),t=c(43365),u=c(32190),v=c(5185),w=c(79748),x=c.n(w),y=c(33873),z=c.n(y),A=c(9288),B=c.n(A);function C(a){return a.replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").toLowerCase()}async function D(a){try{await x().access(a)}catch{await x().mkdir(a,{recursive:!0})}}async function E(a,b){try{let c=`avatar-${Date.now()}.jpg`,d=z().join(process.cwd(),"public"),e=z().join(d,"uploads"),f=z().join(e,C(b)),g=z().join(f,"Avatar");console.log(`Creating directory: ${g}`),await D(g);let h=z().join(g,c),i=await a.arrayBuffer(),j=Buffer.from(i);await x().writeFile(h,j),console.log(`Raw file saved to ${h}`);try{let a=await B()(j).resize(300,300,{fit:B().fit.cover,position:B().strategy.entropy}).jpeg({quality:80}).toBuffer();await x().writeFile(h,a),console.log("Image resized successfully")}catch(a){console.error("Resize failed, keeping original:",a)}let k=z().join("uploads",C(b),"Avatar",c),l="/"+k.replace(/\\/g,"/");return{success:!0,url:l,key:l}}catch(a){return console.error("Simple upload avatar error:",a),{success:!1,error:`Lỗi kh\xf4ng x\xe1c định: ${a.message}`}}}let F=["image/jpeg","image/png","image/webp"];function G(a){let b=["B","KB","MB","GB"],c=a,d=0;for(;c>=1024&&d<b.length-1;)c/=1024,d++;return`${c.toFixed(2)} ${b[d]}`}async function H(a,b="info",c){try{let d=new Date().toISOString(),e=z().join(process.cwd(),"logs");await x().mkdir(e,{recursive:!0});let f=z().join(e,"avatar-upload.log"),g=`[${d}] `;switch(b){case"error":g+="❌ ";break;case"success":g+="✅ ";break;default:g+="ℹ️ "}g+=a,c&&(g+="\n"+JSON.stringify(c,null,2)),await x().appendFile(f,g+"\n\n")}catch(a){console.error("Failed to write to log file:",a)}}async function I(a){let b=performance.now();await H("Avatar upload request received","info");try{let c=Object.fromEntries(a.headers.entries()),d={...c,cookie:c.cookie?"[REDACTED]":void 0,authorization:c.authorization?"[REDACTED]":void 0};await H("Request headers received","info",d);let e=await a.formData(),f=e.get("file"),g=e.get("artistName"),h=e.get("userId"),i=e.get("role");await H("Request parameters received","info",{fileName:f?.name||"missing",fileSize:f?G(f.size):"N/A",fileType:f?.type||"N/A",artistName:g||"missing",hasUserId:!!h,role:i||"missing"});let j=[];if(f||j.push("file"),g||j.push("artistName"),h||j.push("userId"),j.length>0){let a=`Missing required fields: ${j.join(", ")}`;return await H(a,"error"),u.NextResponse.json({success:!1,message:a},{status:400})}try{if(f.size>5242880)throw Error(`File size (${G(f.size)}) exceeds maximum allowed size (${G(5242880)})`);if(!F.includes(f.type))throw Error(`File type ${f.type} is not allowed. Allowed types: ${F.join(", ")}`);await H("File validation passed","success",{fileName:f.name,fileSize:G(f.size),fileType:f.type})}catch(b){let a=b instanceof Error?b.message:String(b);return await H("File validation failed","error",{error:a}),u.NextResponse.json({success:!1,message:a},{status:400})}try{let a=await f.arrayBuffer(),c=Buffer.from(a);await H("File buffer created successfully","success",{fileName:f.name,bufferSize:G(c.length)}),await H("Starting file upload","info",{method:"simple"});let d=await E(f,g);if(d.success){let a=((performance.now()-b)/1e3).toFixed(2);return await H("Upload completed successfully","success",{url:d.url,duration:`${a}s`}),u.NextResponse.json(d)}throw Error("Simple upload failed")}catch(a){await H("Simple upload failed, attempting alternate method","error",{error:a instanceof Error?a.message:String(a)});try{let a=await (0,v.A8)(f,g);if(a.success){let c=((performance.now()-b)/1e3).toFixed(2);return await H("Alternate upload completed successfully","success",{url:a.url,duration:`${c}s`}),u.NextResponse.json(a)}throw Error("Alternate upload failed")}catch(a){return await H("All upload attempts failed","error",{error:a instanceof Error?a.message:String(a)}),u.NextResponse.json({success:!1,message:"Failed to upload file after multiple attempts"},{status:500})}}}catch(a){return await H("Unexpected error occurred","error",{error:a instanceof Error?a.message:String(a)}),u.NextResponse.json({success:!1,message:"An unexpected error occurred"},{status:500})}}let J=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/upload/avatar/route",pathname:"/api/upload/avatar",filename:"route",bundlePath:"app/api/upload/avatar/route"},distDir:".next",projectDir:"",resolvedPagePath:"F:\\studio.ankun\\app\\api\\upload\\avatar\\route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:K,workUnitAsyncStorage:L,serverHooks:M}=J;function N(){return(0,g.patchFetch)({workAsyncStorage:K,workUnitAsyncStorage:L})}async function O(a,b,c){var d;let e="/api/upload/avatar/route";"/index"===e&&(e="/");let g=await J.prepare(a,b,{srcPage:e,multiZoneDraftMode:"false"});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||J.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===J.isDev||!E,H=E&&!G,I=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{dynamicIO:!!w.experimental.dynamicIO,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>J.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>J.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await J.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await J.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await J.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},96487:()=>{}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[985,55],()=>b(b.s=87317));module.exports=c})();